String.prototype.trunc=function(a){return this.substr(0,a-1)+(this.length>a?' <a href="#" id="sinopse_completa">...Mais</a>':"")};var rfmg={url:"http://beta.refilmagem.com.br",request:function(b,d){query='select * from json where url="'+b+'"';var a=encodeURIComponent(query.toLowerCase()),c="http://query.yahooapis.com/v1/public/yql?q="+a+"&format=json&callback=?";$.getJSON(c,d)},nome_cidade_coords:function(c,d,f){var e=this;query="select locality1 from geo.places where woeid in (select place.woeid from flickr.places where lat='"+c+"' and lon='"+d+"')";var a=encodeURIComponent(query.toLowerCase()),b="http://query.yahooapis.com/v1/public/yql?q="+a+"&format=json&callback=?";latlon=c+","+d;$.getJSON(b,function(g){cidade=g.query.results.place.locality1.content;f.call(e,cidade)})},service_request:function(a,b){url=rfmg.url+"/services/json/";$.ajax({type:"GET",dataType:"jsonp",url:url,data:a,success:b})},cidade_meta:function(a,c){var b=this;params={method:"views.get",view_name:"lista_cidades",display_id:"page_3",args:[a],};rfmg.service_request(params,function(d){metadata=d.data[0];c.call(b,metadata)})},cidades:function(b){var a=this;params={method:"views.get",view_name:"lista_cidades",display_id:"page_1"};rfmg.service_request(params,function(c){cidades=c.data;b.call(a,cidades)})},cinemas:function(a,c){var b=this;params={method:"views.get",view_name:"cinemas",display_id:"default",args:[a]};rfmg.service_request(params,function(d){cinemas=d.data;var f=new Array();var e="";$.each(cinemas,function(g,h){if(e==h.node_node_data_field_ref_cinema_nid){return true}telefone=h.node_node_data_field_ref_cinema_node_data_field_telefone_field_telefone_value;site=h.node_node_data_field_ref_cinema_node_data_field_url_field_url_value;var j={nid:h.node_node_data_field_ref_cinema_nid,nome:h.node_node_data_field_ref_cinema_title,endereco:h.node_node_data_field_ref_cinema__node_revisions_body,telefone:telefone,site:site,};f.push(j);e=j.nid});c.call(b,f)})},get_node:function(c,b){var a=this;params={method:"node.get",nid:c};rfmg.service_request(params,function(d){node=d.data;b.call(a,node)})},filme:function(c,b){var a=this;params={method:"views.get",view_name:"filme",display_id:"default",args:[c]};rfmg.service_request(params,function(d){filmes=d.data;b.call(a,filmes)})},filmes_em_cartaz:function(b){var a=this;params={method:"views.get",view_name:"frontpage",display_id:"block_1",args:[cidade]};rfmg.service_request(params,function(c){filmes=c.data;b.call(a,filmes)})},estreias_da_semana:function(a,c){var b=this;params={method:"views.get",view_name:"frontpage",display_id:"default",args:[a,a]};rfmg.service_request(params,function(d){filmes=d.data;c.call(b,filmes)})},filmes_em_cartaz:function(a,c){var b=this;params={method:"views.get",view_name:"frontpage",display_id:"default",args:[a]};rfmg.service_request(params,function(d){filmes=d.data;c.call(b,filmes)})},horarios_filme:function(b,d,g){var f=this;params={method:"views.get",view_name:"horarios_filme",display_id:"default",args:[b,d]};var c=new Object();var a=new Array();var e="";rfmg.service_request(params,function(h){$.each(h.data,function(i,j){cinema_id=j.node_node_data_field_ref_cinema_nid;cinema_nome=j.node_node_data_field_ref_cinema_title;horario=j.node_data_field_horario_field_horario_value;endereco=j.node_node_data_field_ref_cinema__node_revisions_body;telefone=j.node_node_data_field_ref_cinema_node_data_field_telefone_field_telefone_value;site=j.node_node_data_field_ref_cinema_node_data_field_url_field_url_value;if(e==cinema_id){c.horario.push(horario)}else{c=new Object();c.id=cinema_id;c.nome=cinema_nome;c.endereco=endereco,c.site=site,c.telefone=telefone,c.horario=new Array(horario);a.push(c)}e=cinema_id});g.call(f,a)})},filme_cinemas:function(b,c,a,e){var d=this;params={method:"views.get",view_name:"filme_cinemas",display_id:"default",args:[b,c,a]};rfmg.service_request(params,function(f){cinemas=f.data;e.call(d,cinemas)})},filmes_cinema:function(a,b,d){var c=this;params={method:"views.get",view_name:"filmes_cinema",display_id:"default",args:[a,b]};rfmg.service_request(params,function(e){filmes=e.data;d.call(c,filmes)})},proximas_sessoes:function(a,c){var b=this;url=rfmg.url+"/api/proximas-sessoes/"+a+"&callback=?";$.getJSON(url,function(d){sessoes=d.nodes;c.call(b,sessoes)})},proximas_sessoes_near_by:function(a,c){var b=this;url=rfmg.url+"/api/proximas-sessoes-cinemas/"+a+"&callback=?";$.getJSON(url,function(d){sessoes=d.nodes;c.call(b,sessoes)})},distancia:function(d,a,f){var e=this;a=$("<div/>").html(a).text();var c="http://maps.google.com/maps/nav?key=ABQIAAAAm_U5X3msZlIawwmBL471ORQT_8O4OvQyFtE47Y-QdJmYm5WEQRQNZtdpTT-nM5SMKeCF5Hxx0pf0KQ&output=json&sensor=false&oe=iso-8859-1&q=";var b=c;b+="from:"+escape(d+" ");b+="to:"+escape(a);b+="&callback=?";$.getJSON(b,function(g){if(g.Status.code!=200){endereco_errado=$("<div/>").html(a).text();url_="http://maps.google.com/maps/geo?key=ABQIAAAAm_U5X3msZlIawwmBL471ORQT_8O4OvQyFtE47Y-QdJmYm5WEQRQNZtdpTT-nM5SMKeCF5Hxx0pf0KQ&q="+endereco_errado+"&oe=iso-8859-1&sensor=false&output=json&callback=?";$.getJSON(url_,function(h){if(h.Status.code==200){endereco_correto=h.Placemark[0].address;gm_url=c;gm_url+="from:"+escape(d+" ");gm_url+="to:"+escape(endereco_correto);gm_url+="&callback=?";$.getJSON(gm_url,function(i){f.call(e,i)})}else{f.call(e,g)}})}else{f.call(e,g)}})},ordena_por_proximidade:function(cinemas,campo_endereco,onde_estou,callback){var _this=this;if(view.minha_cidade().latlon==null){callback.call(_this,cinemas);return}var z=0;$.each(cinemas,function(key,cinema){endereco=eval("cinema."+campo_endereco);rfmg.distancia(onde_estou,endereco,function(distancia){if(distancia.Status.code==200){cinema.distancia=parseInt(distancia.Directions.Distance.meters);cinema.dtempo=distancia.Directions.summaryHtml}else{cinema.distancia=parseInt(999990)}z++;if(z==cinemas.length){cinemas.sort(function(a,b){return a.distancia-b.distancia});callback.call(_this,cinemas)}})})},};view={onde_estou:"",cidade:"",nome_cidade:"",set_minha_localizacao:function(a,c,b){onde_estou=a;view.set_minha_cidade(c,b)},set_minha_cidade:function(b,a){cidade=b;nome_cidade=a},minha_cidade:function(){return{id:cidade,nome:nome_cidade,latlon:onde_estou}},grava_cache:function(a){if($("body").data(a)){return true}$("body").data(a,true)},limpa_cache:function(a){$("body").data(a,false)},cidades:function(){view.loaderVisible(true);if(view.grava_cache("cidades")){view.loaderVisible(false);return}var a=false;rfmg.cidades(function(c){var b="";$.each(c,function(e,d){b="";a=false;if(d.tid==cidade){a=true}anchor=$("<a/>",{id:d.tid,href:"#home",text:d.term_data_name});list_item=$("<li/>").attr("class","arrow").append(anchor);if(a){anchor.wrap('<span class="cidade_default" />')}$("#cidades ul").append(list_item)});view.loaderVisible(false);$("#cidades ul li a").click(function(){$("#cidades ul li span.cidade_default").removeClass("cidade_default");$(this).wrap('<span class="cidade_default"/>');cidade_id=$(this).attr("id");nome=$(this).text();view.set_minha_cidade(cidade_id,nome);view.limpa_cache("cinemas");view.limpa_cache("cinema");view.limpa_cache("filmes_em_cartaz")})})},filme:function(a){view.loaderVisible(true);$("#poster img").remove();$("#poster").addClass("loading");$("#horarios, #sinopse, #resto_sinopse, #estrelas, #detalhes p").empty();$("#titulo_original, #tempo, #classificacao, #genero, #formato").hide();rfmg.filme(a,function(c){c=c[0];tempo=c.node_data_field_idade_field_tempo_value;idade=c.node_data_field_idade_field_idade_value;trailer=c.node_data_field_trailer_field_trailer_value;pre_estreia=c.node_data_field_idade_field_pre_estreia_api_value;estreia=c.node_data_field_idade_field_estreia_api_value;titulo_original=c.node_data_field_idade_field_original_title_value;site=c.node_data_field_url_field_url_value;movie_id_name=c.node_data_field_idade_field_movie_id_name_value;lingua=c.term_data_node_1_name;genero=c.term_data_node_name;estrelas=c.votingapi_cache_node_percent_vote_average_value;sinopse=view.strip_html(c.node_revisions_body);sinopse_full=sinopse;sinopse=sinopse.trunc(120);poster=c.files_node_data_field_poster_filepath;poster_url=rfmg.url+"/sites/default/files/imagecache/iphone/"+poster;if(pre_estreia!=null){pre_estreia=pre_estreia.split(",");if($.inArray(cidade,pre_estreia)!=-1){pre_estreia=true;$("#filme h2").append('<span class="detalhes_filme">(pre-estreia)</span>')}}if(estreia!=null&&pre_estreia==false){estreia=estreia.split(",");if($.inArray(cidade,estreia)!=-1){$("#filme h2").append('<span class="detalhes_filme">(estreia)</span>')}}for(var d=0;d<5;d++){estrela=$("<div/>").css("width","0%");if(estrelas>=20){estrela.css("width","100%")}else{if(estrelas>0){estrela.css("width",(100-estrelas)+"%")}}estrela=$("<div/>").addClass("estrela").append(estrela);$("#estrelas").append(estrela);estrelas=(estrelas-20)}rfmg.horarios_filme(movie_id_name,cidade,function(e){rfmg.ordena_por_proximidade(e,"endereco",onde_estou,function(f){$.each(e,function(g,h){anchor=$("<a/>",{id:h.id,href:"#",text:h.nome,alt:h.telefone,title:h.endereco,rel:h.site,rev:h.dtempo,});list_item=$("<li/>").attr("class","arrow").append(anchor);ul_cinema=$("<ul/>").addClass("rounded nome_cinema").append(list_item);$("<div/>").addClass("cinema").attr("id","c"+h.id).append(ul_cinema).appendTo("#horarios");div=$("div#c"+h.id).append('<ul class="horarios_cinema"/>');$.each(h.horario,function(j,i){horafilme=new Date(new Date().toDateString()+" "+i);hora=new Date();if(hora>=horafilme){$("<li/>").addClass("movie_started").text(i).appendTo($("ul:last",div))}else{$("<li/>").text(i).appendTo($("ul:last",div))}});$("<li/>").text(".").addClass("clear").appendTo($("ul:last",div))});view.loaderVisible(false);$("#horarios ul li a").click(function(){id=$(this).attr("id");nome=$(this).text();endereco=$(this).attr("title");telefone=$(this).attr("alt");site=$(this).attr("rel");distancia=$(this).attr("rev");view.filmes_cinema(id,nome,endereco,telefone,site,distancia);jqt.goTo("#cinema");return false})})});if(tempo){$("#tempo p").html(tempo).parent().show()}if(idade){$("#classificacao p").html(idade).parent().show()}if(genero){$("#genero p").html(genero).parent().show()}if(lingua){$("#formato p").html(lingua).parent().show()}$("#sinopse").html(sinopse);$("#sinopse_completa").click(function(){$("#sinopse").html(sinopse_full);return false});var b=new Image();$(b).load(function(){$(this).hide();$("#poster").removeClass("loading").append(this);$(this).fadeIn()}).attr("src",poster_url)})},strip_html:function(a){texto=a.replace(/<(.|\n)*?>/g,"");texto=texto.replace(/\r\n\r\n/g,"</p><p>").replace(/\n\n/g,"</p><p>");texto=texto.replace(/\r\n/g,"<br />").replace(/\n/g,"<br />");return texto},proximas_sessoes:function(){$("#proximas-sessoes ul").empty();$("#proximas-sessoes h2#nenhuma_sessao").remove();view.loaderVisible(true);var a=new Array();if(view.minha_cidade().latlon!=null){rfmg.cinemas(cidade,function(b){rfmg.ordena_por_proximidade(b,"endereco",onde_estou,function(c){$.each(c,function(d,e){if(d>=3){return true}a.push(e.nid)});a=a.join(",");rfmg.proximas_sessoes_near_by(a,function(d){if(sessoes===undefined){view.loaderVisible(false);$("#proximas-sessoes").append('<h2 id="nenhuma_sessao">Nenhuma sessão por enquanto.</h2>');return}$.each(d,function(e,f){sessao=f.hora+" › "+f.filme;sessao=sessao+'<span class="detalhes_filme">'+f.cinema+"</span>";class_=cidade+" "+f.hora;anchor=$("<a/>",{id:f.nid,alt:f.hora,href:"#filme",html:sessao});list_item=$("<li/>").attr("class","arrow").append(anchor);$("#proximas-sessoes ul").append(list_item)});$("#proximas-sessoes h2").text("Próximas sessões aqui perto...");view.loaderVisible(false)})})})}else{rfmg.proximas_sessoes(cidade,function(b){if(b===undefined){view.loaderVisible(false);$("#proximas-sessoes").append('<h2 id="nenhuma_sessao">Nenhuma sessão por enquanto.</h2>');return}$.each(b,function(c,d){sessao=d.hora+" › "+d.title;class_=cidade+" "+d.hora;anchor=$("<a/>",{id:d.nid,alt:d.hora,href:"#filme",text:sessao});list_item=$("<li/>").attr("class","arrow").append(anchor);$("#proximas-sessoes ul").append(list_item);view.loaderVisible(false)})})}},filmes_cinema:function(e,b,f,a,c,d){view.loaderVisible(true);$("#cinema ul, #cinema h2, #cinema #endereco_cinema").empty();if(a!="null"&&a!=""){f=f+'<span class="telefone">'+a+"</span>"}if(c!="null"&&c!=""){f=f+'<span class="site"><a href="'+c+'">Site oficial</a></span>'}if(d!="null"&&d!=""){f=f+'<span class="distancia">Distância: '+d+"</span>"}$("#cinema h2").text(b);$("#cinema #endereco_cinema").html(f);rfmg.filmes_cinema(e,cidade,function(h){var g=new Array();$.each(h,function(j,i){nid=i.node_node_data_field_ref_filme_nid;b=i.node_node_data_field_ref_filme_title;b=b.replace("(dublado)","");estreia=i.node_node_data_field_ref_filme_node_data_field_estreia_api_field_estreia_api_value;pre_estreia=i.node_node_data_field_ref_filme_node_data_field_estreia_api_field_pre_estreia_api_value;poster=i.files_node_data_field_poster_filepath;lingua=i.node_node_data_field_ref_filme__term_data_name;g=new Array();if(lingua=="Dublado"){g.push("(dublado)")}if(pre_estreia!=null){pre_estreias=pre_estreia.split(",");if($.inArray(cidade,pre_estreias)!=-1){g.push("(pre-estreia)");pre_estreia=true}}if(estreia!=null&&pre_estreia==false){estreias=estreia.split(",");if($.inArray(cidade,estreias)!=-1){g.push("(estreia)")}}if(g.length>0){g=g.join(" ");g='<span class="detalhes_filme">'+g+"</span>"}else{g=""}anchor=$("<a/>",{id:nid,href:"#filme",html:b+g,});list_item=$("<li/>").attr("class","arrow").append(anchor);$("#cinema ul").append(list_item);view.loaderVisible(false)})})},filmes_em_cartaz:function(){view.loaderVisible(true);if(view.grava_cache("filmes_em_cartaz")){view.loaderVisible(false);return}$("#filmes-em-cartaz ul").empty();$("#filmes-em-cartaz h2").hide();var a=[];rfmg.estreias_da_semana(cidade,function(c){if(c.length==0){$("#estreias_label, #lista_estreias").hide()}else{$("#estreias_label, #lista_estreias").show();$.each(c,function(d,e){detalhes_filme=new Array();pre_estreia=e.node_node_data_field_ref_filme_node_data_field_poster_field_pre_estreia_api_value;if(pre_estreia!=null){pre_estreia=pre_estreia.split(",");if($.inArray(cidade,pre_estreia)!=-1){detalhes_filme.push("(pre-estreia)")}}nome=e.node_node_data_field_ref_filme_title;nome=nome.replace("(dublado)","");if(e.node_node_data_field_ref_filme_title!=nome){detalhes_filme.push("(dublado)")}if(detalhes_filme.length>0){detalhes_filme=detalhes_filme.join(" ");detalhes_filme='<span class="detalhes_filme">'+detalhes_filme+"</span>"}else{detalhes_filme=""}anchor=$("<a/>",{id:e.node_node_data_field_ref_filme_nid,href:"#filme",html:nome+detalhes_filme,});list_item=$("<li/>").attr("class","arrow").append(anchor);a.push(list_item)});$.fn.append.apply($("#lista_estreias"),a)}});var b=[];rfmg.filmes_em_cartaz(cidade,function(c){$.each(c,function(e,d){nome=d.node_node_data_field_ref_filme_title;nome=nome.replace("(dublado)","");dublado="";if(d.node_node_data_field_ref_filme_title!=nome){dublado='<span class="detalhes_filme">(dublado)</span>'}anchor=$("<a/>",{id:d.node_node_data_field_ref_filme_nid,href:"#filme",html:nome+dublado,});list_item=$("<li/>").attr("class","arrow").append(anchor);b.push(list_item)});$("#filmes-em-cartaz h2:last").show();$.fn.append.apply($("#lista_filmes_em_cartaz"),b);view.loaderVisible(false)})},cinemas:function(){view.loaderVisible(true);if(view.grava_cache("cinemas")){view.loaderVisible(false);return}$("#cinemas ul").empty();var a=[];rfmg.cinemas(cidade,function(b){rfmg.ordena_por_proximidade(b,"endereco",onde_estou,function(c){$.each(c,function(d,e){anchor=$("<a/>",{id:e.nid,href:"#",text:e.nome,title:e.endereco,alt:e.telefone,rel:e.site,rev:e.dtempo,});list_item=$("<li/>").attr("class","arrow").append(anchor);a.push(list_item)});$.fn.append.apply($("#cinemas ul"),a);view.loaderVisible(false);$("#cinemas ul li a").click(function(){id=$(this).attr("id");nome=$(this).text();endereco=$(this).attr("title");telefone=$(this).attr("alt");site=$(this).attr("rel");distancia=$(this).attr("rev");view.filmes_cinema(id,nome,endereco,telefone,site,distancia);jqt.goTo("#cinema");return false})})})},loaderVisible:function(a){if(a){$("#loader").css({display:"block"})}else{$("#loader").css("display","none")}},init:function(a,b){rfmg.cidade_meta(b,function(c){if(c===undefined){cidade_id="231";b="São Paulo"}else{cidade_id=c.tid}$("#home ul").show();$("#home h2").text(b);view.loaderVisible(false);view.set_minha_localizacao(a,cidade_id,b);$("#home ul li a").click(function(d){id=$(this).attr("href");switch(id){case"#cidades":view.cidades();break;case"#cinemas":view.cinemas();break;case"#proximas-sessoes":view.proximas_sessoes();break}})})},};var jqt=new $.jQTouch({useFastTouch:false,statusBar:"black-translucent",});$(function(){$("#home ul").hide();view.loaderVisible(true);navigator.geolocation.getCurrentPosition(function(a){latlong=a.coords.latitude+","+a.coords.longitude;rfmg.nome_cidade_coords(a.coords.latitude,a.coords.longitude,function(b){view.init(latlong,b)})},function(){cidade="São Paulo";view.init(null,cidade)});$("#proximas-sessoes ul, #filmes-em-cartaz ul, #cinema ul, #cinemas ul").click(function(){view.loaderVisible(true)});$("#filme").bind("pageAnimationEnd",function(b,a){if(a.direction=="out"){return}ref=$(this).data("referrer");nid=ref.attr("id");filme=ref.text();filme=filme.replace("(dublado)","");filme=filme.replace("(pre-estreia)","");$("#filme h2").text(filme);view.filme(nid)});$("#filmes-em-cartaz").bind("pageAnimationEnd",function(b,a){if(a.direction=="out"){return}view.filmes_em_cartaz()});$("#home").bind("pageAnimationEnd",function(b,a){if(a.direction=="out"){return}$("h2",$(this)).text(view.minha_cidade().nome)})});